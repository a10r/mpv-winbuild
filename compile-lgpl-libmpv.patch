From e557d8dcdea76e21b631b71be058f8fe6d9fdd7b Mon Sep 17 00:00:00 2001
From: Andreas Bauer <a10r@users.noreply.github.com>
Date: Tue, 25 Jun 2024 16:02:57 +0200
Subject: [PATCH] [PATCH] disable all optional mpv dependencies

---
 cmake/packages_check.cmake |  6 +---
 packages/ffmpeg.cmake      | 23 -------------
 packages/libarchive.cmake  |  3 +-
 packages/mpv.cmake         | 66 +++++++++++++-------------------------
 4 files changed, 24 insertions(+), 74 deletions(-)

diff --git a/cmake/packages_check.cmake b/cmake/packages_check.cmake
index e90ecfd..4779b14 100644
--- a/cmake/packages_check.cmake
+++ b/cmake/packages_check.cmake
@@ -6,11 +6,7 @@ if(COMPILER_TOOLCHAIN STREQUAL "gcc")
     set(ffmpeg_extra_libs "-lstdc++")
     set(libjxl_unaligned_vector "-Wa,-muse-unaligned-vector-move") # fix crash on AVX2 proc (64bit) due to unaligned stack memory
     set(mpv_copy_debug COMMAND ${CMAKE_COMMAND} -E copy <BINARY_DIR>/mpv.debug ${CMAKE_CURRENT_BINARY_DIR}/mpv-debug/mpv.debug)
-    set(mpv_add_debuglink COMMAND ${EXEC} ${TARGET_ARCH}-objcopy --only-keep-debug <BINARY_DIR>/mpv.exe <BINARY_DIR>/mpv.debug
-                          COMMAND ${EXEC} ${TARGET_ARCH}-strip -s <BINARY_DIR>/mpv.exe
-                          COMMAND ${EXEC} ${TARGET_ARCH}-objcopy --add-gnu-debuglink=<BINARY_DIR>/mpv.debug <BINARY_DIR>/mpv.exe
-                          COMMAND ${EXEC} ${TARGET_ARCH}-strip -s <BINARY_DIR>/mpv.com
-                          COMMAND ${EXEC} ${TARGET_ARCH}-strip -s <BINARY_DIR>/libmpv-2.dll)
+    set(mpv_add_debuglink COMMAND ${EXEC} ${TARGET_ARCH}-strip -s <BINARY_DIR>/libmpv-2.dll)
 elseif(COMPILER_TOOLCHAIN STREQUAL "clang")
     set(vapoursynth_pkgconfig_libs "-lVapourSynth -Wl,-delayload=VapourSynth.dll")
     set(vapoursynth_script_pkgconfig_libs "-lVSScript -Wl,-delayload=VSScript.dll")
diff --git a/packages/ffmpeg.cmake b/packages/ffmpeg.cmake
index c3afe92..a91ae91 100644
--- a/packages/ffmpeg.cmake
+++ b/packages/ffmpeg.cmake
@@ -1,18 +1,13 @@
 ExternalProject_Add(ffmpeg
     DEPENDS
         amf-headers
-        avisynth-headers
         nvcodec-headers
         bzip2
         lame
         lcms2
         openssl
-        libssh
-        libsrt
         libass
         libbluray
-        libdvdnav
-        libdvdread
         libmodplug
         libpng
         libsoxr
@@ -26,24 +21,18 @@ ExternalProject_Add(ffmpeg
         opus
         speex
         vorbis
-        x264
-        ${ffmpeg_x265}
-        xvidcore
         libxml2
         libvpl
         libopenmpt
         libjxl
         shaderc
         libplacebo
-        libzvbi
         libaribcaption
         aom
         svtav1
         dav1d
         vapoursynth
         uavs3d
-        davs2
-        rubberband
         libva
         openal-soft
     GIT_REPOSITORY https://github.com/FFmpeg/FFmpeg.git
@@ -59,15 +48,11 @@ ExternalProject_Add(ffmpeg
         --pkg-config-flags=--static
         --enable-cross-compile
         --enable-runtime-cpudetect
-        --enable-gpl
         --enable-version3
         --enable-postproc
-        --enable-avisynth
         --enable-vapoursynth
         --enable-libass
         --enable-libbluray
-        --enable-libdvdnav
-        --enable-libdvdread
         --enable-libfreetype
         --enable-libfribidi
         --enable-libfontconfig
@@ -81,28 +66,20 @@ ExternalProject_Add(ffmpeg
         --enable-libspeex
         --enable-libvorbis
         --enable-libbs2b
-        --enable-librubberband
         --enable-libvpx
         --enable-libwebp
-        --enable-libx264
-        --enable-libx265
         --enable-libaom
         --enable-libsvtav1
         --enable-libdav1d
-        --enable-libdavs2
         --enable-libuavs3d
-        --enable-libxvid
         --enable-libzimg
         --enable-openssl
         --enable-libxml2
         --enable-libmysofa
-        --enable-libssh
-        --enable-libsrt
         --enable-libvpl
         --enable-libjxl
         --enable-libplacebo
         --enable-libshaderc
-        --enable-libzvbi
         --enable-libaribcaption
         --enable-cuda-llvm
         --enable-cuvid
diff --git a/packages/libarchive.cmake b/packages/libarchive.cmake
index 4773fae..2e9027a 100644
--- a/packages/libarchive.cmake
+++ b/packages/libarchive.cmake
@@ -2,7 +2,6 @@ ExternalProject_Add(libarchive
     DEPENDS
         bzip2
         expat
-        lzo
         xz
         zlib
         zstd
@@ -26,7 +25,7 @@ ExternalProject_Add(libarchive
         -DENABLE_ICONV=ON
         -DENABLE_LIBXML2=ON
         -DENABLE_EXPAT=ON
-        -DENABLE_LZO=ON
+        -DENABLE_LZO=OFF
         -DENABLE_LZMA=ON
         -DENABLE_CPIO=OFF
         -DENABLE_CNG=OFF
diff --git a/packages/mpv.cmake b/packages/mpv.cmake
index 9cb510e..05a5eb5 100644
--- a/packages/mpv.cmake
+++ b/packages/mpv.cmake
@@ -1,27 +1,10 @@
 ExternalProject_Add(mpv
     DEPENDS
-        angle-headers
         ffmpeg
         fribidi
-        lcms2
-        libarchive
         libass
-        libdvdnav
-        libdvdread
-        libiconv
-        libjpeg
         libpng
-        luajit
-        rubberband
-        uchardet
-        openal-soft
-        mujs
-        vulkan
-        shaderc
         libplacebo
-        spirv-cross
-        vapoursynth
-        libsdl2
     GIT_REPOSITORY https://github.com/mpv-player/mpv.git
     SOURCE_DIR ${SOURCE_LOCATION}
     GIT_CLONE_FLAGS "--filter=tree:0"
@@ -32,27 +15,32 @@ ExternalProject_Add(mpv
         --cross-file=${MESON_CROSS}
         --default-library=shared
         --prefer-static
+        -Dgpl=false
         -Ddebug=true
         -Db_ndebug=true
         -Doptimization=3
         -Db_lto=true
         ${mpv_lto_mode}
+        -Dcplayer=false
         -Dlibmpv=true
-        -Dpdf-build=enabled
-        -Dlua=enabled
-        -Djavascript=enabled
-        -Dsdl2=enabled
-        -Dlibarchive=enabled
-        -Dlibbluray=enabled
-        -Ddvdnav=enabled
-        -Duchardet=enabled
-        -Drubberband=enabled
-        -Dlcms2=enabled
-        -Dopenal=enabled
-        -Dspirv-cross=enabled
-        -Dvulkan=enabled
-        -Dvapoursynth=enabled
-        -Degl-angle=enabled
+        -Dpdf-build=disabled
+        -Dlua=disabled
+        -Djavascript=disabled
+        -Dsdl2=disabled
+        -Dlibarchive=disabled
+        -Dlibbluray=disabled
+        -Ddvdnav=disabled
+        -Duchardet=disabled
+        -Drubberband=disabled
+        -Dlcms2=disabled
+        -Dopenal=disabled
+        -Dspirv-cross=disabled
+        -Dvulkan=disabled
+        -Dvapoursynth=disabled
+        -Degl-angle=disabled
+		-Dshaderc=disabled
+		-Diconv=disabled
+		-Djpeg=disabled
         -Dc_args='-Wno-error=int-conversion'
     BUILD_COMMAND ${EXEC} LTO_JOB=1 PDB=1 ninja -C <BINARY_DIR>
     INSTALL_COMMAND ""
@@ -67,11 +55,6 @@ ExternalProject_Add_Step(mpv strip-binary
 
 ExternalProject_Add_Step(mpv copy-binary
     DEPENDEES strip-binary
-    COMMAND ${CMAKE_COMMAND} -E copy <BINARY_DIR>/mpv.exe                           ${CMAKE_CURRENT_BINARY_DIR}/mpv-package/mpv.exe
-    COMMAND ${CMAKE_COMMAND} -E copy <BINARY_DIR>/mpv.com                           ${CMAKE_CURRENT_BINARY_DIR}/mpv-package/mpv.com
-    COMMAND ${CMAKE_COMMAND} -E copy <BINARY_DIR>/mpv.pdf                           ${CMAKE_CURRENT_BINARY_DIR}/mpv-package/doc/manual.pdf
-    COMMAND ${CMAKE_COMMAND} -E copy ${MINGW_INSTALL_PREFIX}/etc/fonts/fonts.conf   ${CMAKE_CURRENT_BINARY_DIR}/mpv-package/mpv/fonts.conf
-    ${mpv_copy_debug}
     COMMAND ${CMAKE_COMMAND} -E copy <BINARY_DIR>/libmpv-2.dll          ${CMAKE_CURRENT_BINARY_DIR}/mpv-dev/libmpv-2.dll
     COMMAND ${CMAKE_COMMAND} -E copy <BINARY_DIR>/libmpv.dll.a          ${CMAKE_CURRENT_BINARY_DIR}/mpv-dev/libmpv.dll.a
     COMMAND ${CMAKE_COMMAND} -E copy <SOURCE_DIR>/libmpv/client.h       ${CMAKE_CURRENT_BINARY_DIR}/mpv-dev/include/mpv/client.h
@@ -91,14 +74,9 @@ mv $2 $2-git-\${GIT}")
 ExternalProject_Add_Step(mpv copy-package-dir
     DEPENDEES copy-binary
     COMMAND chmod 755 ${RENAME}
-    COMMAND mv ${CMAKE_CURRENT_BINARY_DIR}/mpv-package ${CMAKE_BINARY_DIR}/mpv-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
-    COMMAND ${RENAME} <SOURCE_DIR> ${CMAKE_BINARY_DIR}/mpv-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
 
-    COMMAND mv ${CMAKE_CURRENT_BINARY_DIR}/mpv-debug ${CMAKE_BINARY_DIR}/mpv-debug-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
-    COMMAND ${RENAME} <SOURCE_DIR> ${CMAKE_BINARY_DIR}/mpv-debug-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
-
-    COMMAND mv ${CMAKE_CURRENT_BINARY_DIR}/mpv-dev ${CMAKE_BINARY_DIR}/mpv-dev-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
-    COMMAND ${RENAME} <SOURCE_DIR> ${CMAKE_BINARY_DIR}/mpv-dev-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
+    COMMAND mv ${CMAKE_CURRENT_BINARY_DIR}/mpv-dev ${CMAKE_BINARY_DIR}/mpv-dev-lgpl-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
+    COMMAND ${RENAME} <SOURCE_DIR> ${CMAKE_BINARY_DIR}/mpv-dev-lgpl-${TARGET_CPU}${x86_64_LEVEL}-${BUILDDATE}
     COMMENT "Moving mpv package folder"
     LOG 1
 )
-- 
2.35.2.windows.1

